<div class="panel-header panel-header-sm"></div>
<div class="main-content">
	<div class="row">
		<div class="col-md-12">
			<div class="card">
				<div class="card-header">
					<h4 class="card-title">Поиск пропусков по торговой точке</h4>
				</div>
				<div class="card-body">
					<!-- Форма поиска -->
					<form [formGroup]="searchForm" (ngSubmit)="searchPasses()" class="mb-4">
						<div class="row mb-2">
							<div class="col-md-3">
								<mat-form-field appearance="outline" class="w-100">
									<mat-label>Здание</mat-label>
									<input matInput formControlName="Building" [matAutocomplete]="autoBuilding"
										(input)="onInput('Building', $event)" />
									<mat-autocomplete #autoBuilding="matAutocomplete"
										(optionSelected)="selectSuggestion('Building', $event)">
										<mat-option *ngFor="let suggestion of buildingSuggestions$ | async"
											[value]="suggestion">
											{{ suggestion }}
										</mat-option>
										<mat-option
											*ngIf="(buildingSuggestions$ | async)?.length === 0 && searchForm.get('Building')?.value && !isFieldConfirmed('Building')"
											disabled>
											Нет совпадений
										</mat-option>
									</mat-autocomplete>
								</mat-form-field>
							</div>
							<div class="col-md-3">
								<mat-form-field appearance="outline" class="w-100">
									<mat-label>Этаж</mat-label>
									<input matInput formControlName="Floor" [matAutocomplete]="autoFloor"
										(input)="onInput('Floor', $event)" />
									<mat-autocomplete #autoFloor="matAutocomplete"
										(optionSelected)="selectSuggestion('Floor', $event)">
										<mat-option *ngFor="let suggestion of floorSuggestions$ | async"
											[value]="suggestion">
											{{ suggestion }}
										</mat-option>
										<mat-option
											*ngIf="(floorSuggestions$ | async)?.length === 0 && searchForm.get('Floor')?.value && !isFieldConfirmed('Floor')"
											disabled>
											Нет совпадений
										</mat-option>
									</mat-autocomplete>
								</mat-form-field>
							</div>
							<div class="col-md-3">
								<mat-form-field appearance="outline" class="w-100">
									<mat-label>Линия</mat-label>
									<input matInput formControlName="Line" [matAutocomplete]="autoLine"
										(input)="onInput('Line', $event)" />
									<mat-autocomplete #autoLine="matAutocomplete"
										(optionSelected)="selectSuggestion('Line', $event)">
										<mat-option *ngFor="let suggestion of lineSuggestions$ | async"
											[value]="suggestion">
											{{ suggestion }}
										</mat-option>
										<mat-option
											*ngIf="(lineSuggestions$ | async)?.length === 0 && searchForm.get('Line')?.value && !isFieldConfirmed('Line')"
											disabled>
											Нет совпадений
										</mat-option>
									</mat-autocomplete>
								</mat-form-field>
							</div>
							<div class="col-md-3">
								<mat-form-field appearance="outline" class="w-100">
									<mat-label>Торговая точка</mat-label>
									<input matInput formControlName="StoreNumber" [matAutocomplete]="autoStoreNumber"
										(input)="onInput('StoreNumber', $event)" />
									<mat-autocomplete #autoStoreNumber="matAutocomplete"
										(optionSelected)="selectSuggestion('StoreNumber', $event)">
										<mat-option *ngFor="let suggestion of storeNumberSuggestions$ | async"
											[value]="suggestion">
											{{ suggestion }}
										</mat-option>
										<mat-option
											*ngIf="(storeNumberSuggestions$ | async)?.length === 0 && searchForm.get('StoreNumber')?.value && !isFieldConfirmed('StoreNumber')"
											disabled>
											Нет совпадений
										</mat-option>
									</mat-autocomplete>
								</mat-form-field>
							</div>
						</div>
						<div class="d-flex justify-content-between align-items-center mt-3">
							<div class="d-flex gap-2">
								<button mat-raised-button color="primary" type="submit"
									[disabled]="isLoading">Поиск</button>
								<button mat-stroked-button color="primary" type="button" (click)="resetFilters()"
									[disabled]="isLoading">Сбросить</button>
								<button mat-flat-button color="accent" type="button" (click)="goToCreateTransaction()"
									[disabled]="isLoading || !showAddTransactionButton"
									matTooltip="Заполните и подтвердите все поля, чтобы добавить транзакцию"
									[matTooltipDisabled]="showAddTransactionButton">
									Добавить
								</button>
							</div>
							<div *ngIf="errorMessage" class="text-danger error-message ms-3">
								{{ errorMessage }}
							</div>
						</div>
					</form>

					<!-- Контейнер для результатов -->
					<div class="table-container">
						<div *ngFor="let result of results; let resultIndex = index" class="mb-4"
							[attr.data-result-index]="resultIndex">
							<!-- Added: Note section -->
							<div class="mb-3">
								<mat-form-field appearance="outline" class="w-100">
									<mat-label>Заметка для {{ formatStore(result) }}</mat-label>
									<input matInput [formControl]="noteControls[resultIndex]"
										placeholder="Введите заметку" />
								</mat-form-field>
								<div class="d-flex gap-2 mt-2">
									<button mat-raised-button color="primary" (click)="saveNote(resultIndex)"
										[disabled]="isLoading">
										Сохранить заметку
									</button>
									<button mat-stroked-button color="warn" (click)="deleteNote(resultIndex)"
										[disabled]="isLoading || !result.note">
										Удалить заметку
									</button>
								</div>
							</div>

							<ng-container
								*ngFor="let item of getContractorsWindowedFor(resultIndex); let i = index; trackBy: trackByFn">
								<table class="table table-bordered contractor-table"
									[attr.data-result-index]="resultIndex"
									[attr.data-contractor-index]="i + windows[resultIndex].start">
									<thead>
										<tr>
											<th>ID</th>
											<th>Фото</th>
											<th>Сканы</th>
											<th>ФИО</th>
											<th>Должность</th>
											<th>Телефон</th>
											<th>Гражданство</th>
											<th>Тип продукции</th>
											<th>Начало</th>
											<th>Окончание</th>
											<th>Действия</th>
										</tr>
									</thead>
									<tbody>
										<tr>
											<td>{{ item.contractor.contractorId }}</td>
											<td class="img-cell">
												<img [src]="getFirstPhotoUrl(item.contractor)" class="contractor-img"
													alt="Фото" (click)="openImage(getFirstPhotoUrl(item.contractor))"
													loading="lazy"
													onerror="this.src='/assets/images/default-photo.jpg'" />
											</td>
											<td class="img-cell">
												<img *ngIf="getLastDocumentPhotoUrl(item.contractor)"
													[src]="getLastDocumentPhotoUrl(item.contractor)"
													class="document-img" alt="Скан"
													(click)="openImage(getLastDocumentPhotoUrl(item.contractor))"
													loading="lazy"
													onerror="this.src='/assets/images/default-doc.png'" />
											</td>
											<td>
												<div class="name-cell">
													<span>{{ getNameParts(item.contractor.contractorName)[0] }}</span>
													<span>{{ getNameParts(item.contractor.contractorName)[1] }}</span>
													<span>{{ getNameParts(item.contractor.contractorName)[2] }}</span>
												</div>
											</td>
											<td>
												{{ (item.isActive ? getLatestPass(item.contractor.activePasses) :
												getLatestPass(item.contractor.closedPasses))?.position || '-' }}
											</td>
											<td>{{ item.contractor.phoneNumber }}</td>
											<td>{{ item.contractor.citizenship }}</td>
											<td>{{ item.contractor.productType }}</td>
											<td>
												{{
												(item.isActive ? getLatestPass(item.contractor.activePasses) :
												getLatestPass(item.contractor.closedPasses))?.startDate
												| date: 'dd.MM.yyyy'
												}}
											</td>
											<td>
												{{
												(item.isActive ? getLatestPass(item.contractor.activePasses) :
												getLatestPass(item.contractor.closedPasses))?.endDate
												| date: 'dd.MM.yyyy'
												}}
											</td>
											<td class="actions-cell">
												<button mat-raised-button color="primary"
													(click)="viewContractor(item.contractor.contractorId)">Просмотр</button>
												<button mat-flat-button color="accent"
													(click)="editContractor(item.contractor.contractorId)">Редактировать</button>
												<button mat-stroked-button color="primary"
													(click)="toggleExpansionPanel(resultIndex, i + windows[resultIndex].start)">Пропуска</button>
											</td>
										</tr>
										<tr>
											<td colspan="11" style="padding: 0">
												<mat-expansion-panel
													[expanded]="isExpanded(resultIndex, i + windows[resultIndex].start)">
													<table class="inner-table">
														<thead>
															<tr>
																<th>Цвет</th>
																<th>Тип</th>
																<th>Срок</th>
																<th>Стоимость</th>
																<th>Дата выдачи</th>
																<th>Дата начала</th>
																<th>Дата окончания</th>
																<th>Место</th>
																<th>Должность</th>
																<th *ngIf="item.isActive">Действия</th>
																<th *ngIf="!item.isActive">Причина закрытия</th>
															</tr>
														</thead>
														<tbody>
															<ng-container *ngIf="item.isActive; else closedPasses">
																<tr
																	*ngFor="let pass of getSortedPasses(item.contractor.activePasses, result)">
																	<td><span class="color-circle"
																			[style.backgroundColor]="pass.passTypeColor || '#ccc'"></span>
																	</td>
																	<td>{{ pass.passTypeName }}</td>
																	<td>{{ pass.passTypeDurationInMonths + ' мес.' }}
																	</td>
																	<td>{{ pass.cost | number: '1.0-0' }}</td>
																	<td>{{ pass.transactionDate | date: 'dd.MM.yyyy' }}
																	</td>
																	<td>{{ pass.startDate | date: 'dd.MM.yyyy' }}</td>
																	<td>{{ pass.endDate | date: 'dd.MM.yyyy' }}</td>
																	<td>{{ pass.building }} {{ pass.floor }} {{
																		pass.line }} {{ pass.storeNumber }}</td>
																	<td>{{ pass.position }}</td>
																	<td>
																		<button mat-raised-button color="primary"
																			(click)="extendPass(pass, result)">Продлить</button>
																		<button mat-flat-button color="warn"
																			(click)="closePass(pass.id)">Закрыть</button>
																	</td>
																</tr>
																<tr *ngIf="item.contractor.activePasses.length === 0">
																	<td colspan="10">Нет активных пропусков у
																		контрагента</td>
																</tr>
															</ng-container>
															<ng-template #closedPasses>
																<tr
																	*ngFor="let pass of getSortedPasses(item.contractor.closedPasses, result)">
																	<td><span class="color-circle"
																			[style.backgroundColor]="pass.passTypeColor || '#ccc'"></span>
																	</td>
																	<td>{{ pass.passTypeName }}</td>
																	<td>{{ pass.passTypeDurationInMonths + ' мес.' }}
																	</td>
																	<td>{{ pass.cost | number: '1.0-0' }}</td>
																	<td>{{ pass.transactionDate | date: 'dd.MM.yyyy' }}
																	</td>
																	<td>{{ pass.startDate | date: 'dd.MM.yyyy' }}</td>
																	<td>{{ pass.endDate | date: 'dd.MM.yyyy' }}</td>
																	<td>{{ pass.building }} {{ pass.floor }} {{
																		pass.line }} {{ pass.storeNumber }}</td>
																	<td>{{ pass.position }}</td>
																	<td>{{ pass.closeReason || '-' }}</td>
																</tr>
																<tr *ngIf="item.contractor.closedPasses.length === 0">
																	<td colspan="10">Нет закрытых пропусков у
																		контрагента</td>
																</tr>
															</ng-template>
														</tbody>
													</table>
												</mat-expansion-panel>
											</td>
										</tr>
									</tbody>
								</table>
							</ng-container>
							<div *ngIf="getContractorsWindowedFor(resultIndex).length === 0" class="text-center">
								Нет контрагентов для отображения
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>